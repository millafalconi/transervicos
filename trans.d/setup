#!/usr/bin/env bash
# vim: ft=sh

SUBCOMMAND_DESC="Verifique o setup do projeto"
SUBCOMMAND_HELP=$(cat <<EOH
Usage ${MAIN_COMMAND} ${SUBCOMMAND} [check] [install]

check Verifica se todas as dependências estão instaladas.
install TODO!

EOH
)

function msg_installed() {
  in_green "OK: "${1}" está instalado"
}

function msg_not_installed() {
  in_red "NOK: "${1}" é necessário. "${1}" não está instalado"
}

function is_plugin_installed() {
  if is_installed ${1}; then
    if [[ $(${1} plugin list | grep "${2}") = *${2}* ]]; then
      msg_installed ${2}
      return
    fi
    msg_not_installed ${2}
  else
    msg_not_installed ${2}
  fi
}

function is_installed() {
  [ -x "$(command -v ${1})" ]
}

function check_version() {
  if is_installed ${1}; then
    min=1.9
    current=$(${1} --version | head -n 1 | awk '{print $NF}' | cut -c 1-3)

    if [ 1 -eq `echo "${current} < ${min}" | bc` ]; then
      in_red "NOK: versão do ansible é menor que ${min}. atualize o ansible."
      return
    fi
    in_green "OK: versão do ansible é maior ou igual a ${min}"
  else
    in_red "NOK: não foi possivel verificar versão do ansible. ansible não instalado"
  fi
}

function check() {
  if is_installed ${1}; then
    msg_installed ${1}
  else
    msg_not_installed ${1}
  fi
}

function install() {
  local to_install=${1}
  case $to_install in
    ansible)
      in_yellow "OK: instalando ${1} via brew..."
      brew install $to_install
      ;;
    vagrant)
      in_yellow "OK: instalando ${1} via brew cask..."
      brew cask install $to_install
      ;;
    *)
      ;;
  esac
}

function parse_choice() {
  local choice=${1}
  case $choice in
    y|Y)
      in_yellow "OK: instalação confirmada."
      ;;
    n|N)
      in_yellow "NOK: instalação não confirmada."
      return -1
      ;;
    *)
      in_red "NOK: $choice não é uma opção válida."
      exit;;
  esac
}

function install_if_missing() {
  local to_be_installed=${1}
  if ! is_installed $to_be_installed; then
    in_yellow "NOK: $to_be_installed é necessário e não foi encontrado"
    in_yellow "$to_be_installed será instalado..."

    read -p "Confirma instalação? (y/n) " choice
    parse_choice ${choice}

    if [[ $? -eq 0 ]]; then
      install $to_be_installed
      if is_installed $to_be_installed; then
        in_green "OK: $to_be_installed instalado com sucesso!"
      else
        in_red "NOK: $to_be_installed não instalado"
      fi
    else
      in_yellow "NOK: $to_be_installed é necessário, mas não foi instalado"
      in_yellow "NOK: encerrando setup para: $to_be_installed"
    fi

  else
    msg_installed $to_be_installed
  fi
}

function check_setup() {
  check "virtualbox"
  check "vagrant"
  is_plugin_installed "vagrant" "vagrant-cachier"
  check "ansible"
  check_version "ansible"
}

function install_all() {
  in_green "Instalando todas as dependências necessárias para o projeto: transervicos"
  install_if_missing "ansible"
  install_if_missing "vagrant"
}

is_help_mode "${@}" && return

case ${1} in
  check)
    check_setup
    ;;
  install)
    install_all
  ;;
esac
